# Лабораторная №6 — журналирование действий

В этой лабе я докрутил наш php-app-secure, чтобы он наконец-то запоминал кто и что делает. Пишу коротко, но по делу, потому что несколько вечеров ушло на разборки с докером и правами на файлы.

## Что я сделал руками
1. **Каталог для логов** — добавил `storage/logs/app.log`, смонтировал через docker-compose и научил конфиг создавать папки автоматически. Теперь тики и логи не теряются после перезапуска контейнера.
2. **Собственный Logger** — написал класс `App\Core\Logger`, который пишет JSON строки вроде `timestamp + level + user_id + action + context`. Специально храню только технические данные (id, role, хэши), никаких имён, чтобы не светить личное.
3. **Инструментирование** — прокинул вызовы логгера во все важные точки: логин/логаут/регистрация, создание админов, тикеты (create/edit/delete/status), гостевую книгу, управление пользователями. Даже «опасный» контроллер тоже логирует, чтобы видно было если кто-то туда залез.
4. **Страница логов** — сделал новую ссылку «Logs» в меню админа. Там классный UI: фильтры по уровню, user_id и action, карточки с выводом и выпадающим `details` для контекста. Доступ только после проверки `is_admin`, иначе редирект на главную.
5. **UX полировка** — добавил стили, чтобы карточки читались, и форму сброса фильтров. Теперь логи удобно листать, а не искать текст в гигантской таблице.

## Ответы на требования из задания
1. *"Используйте ранее созданное приложение"* — я всё делал прямо в `php-app-secure`, никакие новые проекты не поднимал.
2. *"Создайте файл логов"* — файл `storage/logs/app.log` создаётся автоматически и хранит записи вида «кто (id/role), когда, какое действие». Примеры: `login_success`, `ticket_updated`, `user_directory_delete` и т.п. Контекст содержит только ID и хэши, без персональной инфы.
3. *"Опция для администратора"* — ссылка `/admin/logs` доступна только после авторизации админа. Внутри слышно весь лог, можно фильтровать и смотреть свежие события в хронологии.
4. *Зачем логирование и почему обезличенно*:
   - **Зачем писать действия**: так проще расследовать подозрительные входы, смотреть кто удалил тикет или создал админа в 3 ночи.
   - **Почему без личных данных**: лог чаще живёт на сервере, который может попасть в чужие руки. Поэтому храню только IDs и хэши, чтобы даже при утечке нельзя было сразу узнать пользователя.
   - **Почему анализировать**: без регулярного просмотра логи превращаются в мусор. В лог UI можно быстро отловить всплеск ошибок или странные действия гостя.
   - **Про ротацию**: когда файл разрастётся, его надо архивировать и очищать. Сейчас для простоты лог один, но я оставил заметку, что если размер > несколько МБ, лучше скриптом переименовать `app.log` в `app.log.YYYYMMDD` и начать новый, чтобы сервер не съел весь диск.

## Как проверить
1. Запустить `sudo docker compose up -d --build` в `php-app-secure` (первый раз подождать пока миграции выполнятся).
2. Зайти на `http://localhost:8080`, залогиниться `admin/admin` или создать нового пользователя.
3. Поделать действия: создать/отредактировать тикет, удалить пользователя, гостевой пост.
4. Зайти в меню **Logs** — список обновится, видно кто что сделал. В `storage/logs/app.log` лежит такая же информация в чистом виде.

Вроде всё. Если что-то не заводится — чаще всего виноваты права на `storage/` или docker pull. Но после фиксов это у меня уже работает стабильно.
