# Отчет по лабораторной работе: система управления тикетами

## Работу выполнили:
 - Мамалига Артур
 - Зайка Григорий

# 1. Введение

В данном отчете представлена информация о разработанном веб-приложении — системе управления тикетами. Приложение реализовано на чистом PHP с использованием Docker для контейнеризации и MySQL в качестве СУБД.

# 2. Инструкции по запуску проекта

### 1. Клонировать репозиторий:

   ```bash
   git clone https://github.com/slendchat/php_individual_work.git
   cd php_individual_work
   ```
### 2. Скопировать шаблон окружения и заполнить параметры:

   ```bash
   cp .env_example .env
   # Открыть .env и указать свои значения для DB_HOST, DB_NAME, DB_USER, DB_PASS
   ```
### 3. Запустить контейнеры и собрать образы:

   ```bash
   docker-compose up --build -d
   ```
### 4. Открыть в браузере адрес:

   ```text
   http://localhost:8080
   ```
### 5. По умолчанию для администратора создана учетная запись:

   * **Email**: `admin`
   * **Пароль**: `admin`

# 3. Описание лабораторной работы

## **Цель работы:** 
Разработка веб-приложения среднего уровня сложности, удовлетворяющего требованиям по аутентификации, CRUD-операциям, ролям, поиску и безопасности.

## **Задачи:**

* Разработать веб-приложение.
* Построить приложение на модульной архитектуре.
* Реализовать безопасную регистрацию и вход с хешированием паролей.
* Построить CRUD-интерфейс для управления тикетами с разделением прав доступа (Общедоступные элементы и защищенные).
* Обеспечить поиск и фильтрацию записей.
* Применить базовые методы защиты.

# 4. Документация проекта

## 4.1. Содержание

* [Функциональные возможности](#41-функциональные-возможности)
* [Сценарии взаимодействия](#42-сценарии-взаимодействия)
* [Структура базы данных](#43-структура-базы-данных)

## 4.2. Функциональные возможности

1. Аутентификация пользователей: регистрация, вход, выход.
2. Роли: гость, пользователь, администратор.
3. Создание тикета с полями: заголовок, описание, категория, приоритет, срок, флаг срочности; статус `Pending` по умолчанию.
4. Просмотр тикетов: гости — только `Open`, пользователи — `Open` и `Closed`, админы — все статусы.
5. Редактирование, удаление и изменение статуса тикета — только для администраторов.
6. Поиск и фильтрация по заголовку, категории и приоритету.
7. Валидация на клиенте (HTML5, JavaScript) и сервере (PHP).
8. Защита: PDO с подготовленными запросами, `htmlspecialchars`, CSRF-токены.

## 4.3. Сценарии взаимодействия

* **Гость:** просматривает открытые тикеты, использует поиск.
* **Зарегистрированный пользователь:** создаёт тикет, смотрит свои и закрытые тикеты.
* **Администратор:** управляет тикетами всех статусов, создаёт новых админов, редактирует и удаляет записи.

- Создание тикета пользователем

![alt text](img/localhost_8080_ticket_create.png)

- Изменение тикета администратором

![alt text](img/localhost_8080_ticket_edit_id=2.png)

- Страница тикета

![alt text](img/localhost_8080_tickets.png)

## 4.4. Структура базы данных

show tables;
| Tables_in_tickets |
| ----------------- |
| tickets           |
| users             |

**Таблица `users`:**

| Field         | Type         | Null | Key | Default           | Extra             | Описание                      |
| ------------- | ------------ | ---- | --- | ----------------- | ----------------- | ----------------------------- |
| id            | int          | NO   | PRI | NULL              | auto_increment    | Уникальный идентификатор      |
| email         | varchar(255) | NO   | UNI | NULL              |                   | Уникальный логин пользователя |
| password_hash | varchar(255) | NO   |     | NULL              |                   | Хэш пароля (`bcrypt`)         |
| is_admin      | tinyint(1)   | YES  |     | 0                 |                   | Флаг администратора (0/1)     |
| created_at    | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED | Время создания записи         |

**Таблица `tickets`:**

| Field       | Type         | Null | Key | Default           | Описание                             |
| ----------- | ------------ | ---- | --- | ----------------- | ------------------------------------ |
| id          | int          | NO   | PRI | NULL              | Идентификатор тикета                 |
| user_id     | int          | NO   | MUL | NULL              | Владелец тикета (FK → `users.id`)    |
| title       | varchar(255) | NO   |     | NULL              | Заголовок                            |
| description | text         | YES  |     | NULL              | Описание проблемы                    |
| category    | varchar(100) | YES  |     | NULL              | Категория (Server, Network, etc.)    |
| priority    | varchar(20)  | YES  |     | NULL              | Приоритет (Low, Medium, High)        |
| due_date    | date         | YES  |     | NULL              | Дата исполнения                      |
| is_urgent   | tinyint(1)   | YES  |     | 0                 | Флаг срочности                       |
| status      | varchar(20)  | YES  |     | Pending           | Статус (`Pending`, `Open`, `Closed`) |
| created_at  | timestamp    | YES  |     | CURRENT_TIMESTAMP | Время создания тикета                |

## 5. Примеры использования проекта

1. **Просмотр списка тикетов:**

   * Открыть `/tickets` — увидеть список.

2. **Поиск:**

   * Ввести в поле `q=Server` и нажать «Search».

3. **Создание тикета:**

   * Авторизоваться, перейти `/ticket/create`, заполнить форму.

4. **Управление админом:**

   * Авторизоваться админом, перейти `/admin/users/create`.

![welcome page](img/localhost_8080_.png)
![create admin page](img/localhost_8080_admin_users_create.png)
![auth page 1](img/localhost_8080_login.png)
![auth page 2](img/localhost_8080_register.png)
![ticket create page](img/localhost_8080_ticket_create.png)
![ticket create alert page](img/localhost_8080_ticket_create%20(1).png)
![ticket edit page](img/localhost_8080_ticket_edit_id=2.png)
![tickets page](img/localhost_8080_tickets.png)

# 6. Ответы на контрольные вопросы

### 1. **Как реализована аутентификация?**

#### Форма входа и регистрации
При переходе на `/login` или `/register` в `AuthController` методами `showLoginForm()` и `showRegisterForm()` рендерятся соответствующие формы.

#### Обработка логина

Считываем из `$_POST` email и «чистый» пароль.
Ищем в БД пользователя по email через PDO-запрос с подготовленным параметром, чтобы избежать SQL-инъекций.
Получаем из столбца `password_hash` bcrypt-хэш и проверяем через `password_verify($pass, $hash)`.
Если проверка прошла — в `$_SESSION['user']` сохраняем `id`, email и `флаг is_admin`, чтобы в дальнейшем контролировать доступ к защищённым разделам.
На ошибки (пустые поля, неверный пароль, отсутствующий email) в сессию кладутся сообщения `$_SESSION['errors']` и делается `header('Location: /login')` с выходом.


#### Обработка регистрации

Извлекаем из `$_POST` `email`, `password` и `password2`, проводим базовую валидацию: все поля заполнены, пароли совпадают, минимальная длина.
Генерируем хэш `password_hash($password, PASSWORD_BCRYPT)` и пытаемся вставить новую запись в таблицу users.
На конфликт по уникальному email ловим PDOException и возвращаемся к форме с ошибкой «User already exists».
При успехе ставим флеш-сообщение `$_SESSION['success'] = 'Registration successful. Please log in.'` и редиректим на `/login`.


#### Разлогинивание

Метод `logout()` просто очищает сессию (`session_unset()`, `session_destroy()`) и отправляет пользователя на главную страницу.


#### Защита и сессии

Во всех контроллерах перед выполнением «приватных» действий проверяется наличие `$_SESSION['user']` и при необходимости флага `$_SESSION['user']['is_admin']`.
Используются только `PDO-prepared statements` и `htmlspecialchars()` для вывода, что закрывает основные векторы XSS и SQL-инъекций.

### 2. **Какие хэш-функции используются для паролей?**

Для хеширования паролей используется встроенная в PHP функция `password_hash()` с алгоритмом `bcrypt(PASSWORD_BCRYPT)`. Соль генерируется автоматически, а проверка проходит через `password_verify()`.

### 3. **Какие меры безопасности применены?**

#### Основные меры безопасности
* Хеширование паролей

   Используем password_hash(..., `PASSWORD_BCRYPT`) и `password_verify()`, так что в БД хранятся только надёжные bcrypt-хеши, без явных солей в коде.

* Подготовленные запросы (PDO)

   Вся работа с базой идёт через PDO + `prepare()`/`execute()`, что надёжно защищает от SQL-инъекций.

* Валидация на клиенте и на сервере

   HTML5-атрибуты (`required`, `maxlength`, `type=date`), JS-скрипты и дублирование проверок в PHP контроллерах исключают мусор и вредоносный ввод.

* Защита от XSS

   При выводе любых переменных в шаблонах используем `htmlspecialchars()`, чтобы не дать вбросить в страницу скрипты.

* CSRF-защита (токены)

   В формах создаётся и проверяется скрытый CSRF-токен из $_SESSION, чтобы посты шли только с нашей же страницы.

* Контроль доступа через сессии

   Страницы `/ticket/create`, `/ticket/edit`, `/admin/*` доступны только при наличии `$_SESSION['user']` и, для админа, флага `is_admin`.

* Безопасная обработка ошибок

   Детали исключений (например, PDOException) не выводятся пользователю, а логируются (или просто показывается общая «Ошибка»), чтобы не сливать потенциально чувствительную информацию.

Также рекомендуется использовать SSL/TLS сертификат для шифрования трафика.

## 4. **Как работает поиск и фильтрация?**

 - Чтение критериев из URL (GET-параметры)

   ```php
   $q        =  trim($_GET['q']        ?? '');  // текстовый запрос
   $category =       $_GET['category'] ?? '';   // выбранная категория
   $priority =       $_GET['priority'] ?? '';   // выбранный приоритет
   ```

   Пользователь вводит эти значения в форму и при сабмите они попадают в строку вида
   `/tickets?q=Server&category=Server&priority=High`.

 - Базовый фильтр по статусу

   В зависимости от роли пользователя добавляем в запрос условие по полю `status`:

   * **Гость** (`!$isLoggedIn`) ― только `status = 'Open'`.
   * **Обычный пользователь** (`$isLoggedIn && !$isAdmin`) ― `status IN ('Open','Closed')`.
   * **Админ** (`$isAdmin`) ― никаких ограничений по статусу.

 - Дополнительные условия
   Для каждого непустого критерия (`q`, `category`, `priority`) добавляем в массив `$whereParts` соответствующее SQL-условие и его параметр в массив `$params`:

   ```php
   if ($q !== '') {
     $whereParts[] = 'title LIKE ?';
     $params[]     = "%{$q}%";
   }
   if ($category !== '') {
     $whereParts[] = 'category = ?';
     $params[]     = $category;
   }
   if ($priority !== '') {
     $whereParts[] = 'priority = ?';
     $params[]     = $priority;
   }
   ```

    Для текста используется `LIKE '%...%'` — частичное совпадение.

    Для категории и приоритета — точное сравнение.

 - Сборка SQL-запроса

   ```php
   $sql = "SELECT id, title, category, status, created_at FROM tickets";
   if ($whereParts) {
     $sql .= ' WHERE ' . implode(' AND ', $whereParts);
   }
   $sql .= ' ORDER BY created_at DESC';
   ```

   Мы динамически «склеиваем» все условия через `AND`, и получаем ровно тот список тикетов, который удовлетворяет всем выбранным фильтрам и правам доступа.

 - Выполнение через PDO

   ```php
   $stmt = $db->prepare($sql);
   $stmt->execute($params);
   $tickets = $stmt->fetchAll(PDO::FETCH_ASSOC);
   ```

   Здесь `$params` — массив значений для каждого `?` в запросе. Подготовленные запросы не только защищают от SQL-инъекций, но и позволяют легко биндинговать любое количество условий.

 - Передача результата в представление 
 
 Вызов

   ```php
   $this->view('tickets/index', [
     'title'   => ...,
     'tickets' => $tickets,
     'isAdmin' => $isAdmin,
     'filters' => compact('q','category','priority'),
   ]);
   ```

   Отдаёт в шаблон массив тикетов и текущие значения фильтров (чтобы прелзаполнить форму), а также флаг `isAdmin` для отображения дополнительных действий.

# 7. Список использованных источников

* [PHP Manual](https://www.php.net/manual/)
* [Docker Documentation](https://docs.docker.com/)
* [MDN Web Docs](https://developer.mozilla.org/)
* [TuiCSS](https://github.com/vinibiavatti1/TuiCss)

# 8. План по последующим дополнениям

* При любом сбое выводить звук модема 56 k.
* Прогресс-бар, который никогда не заканчивается.
* 60-секундная задержка на каждое действие для реалистичности.
* Ручное подтверждение модератором через калькулятор, вместо CAPTCHA.
* Кнопка создания рандомных тикетов (Enterprise версия по подписке).