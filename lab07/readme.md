# Лабораторная №7 — Ошибки и журналирование

В этой лабе нужно было приручить все ошибки в приложении php-app-secure. Задание сначала казалось скучным, но когда PHP начал сыпать ворнинги прямо в браузер — понял зачем это всё.

## Что я сделал

1. **Отдельный error.log** — в `storage/logs` теперь лежит не только `app.log`, но и `error.log`. Через новый `App\Core\ErrorLogger` туда пролетают все предупреждения, фаталы и исключения.
2. **Глобальные обработчики** — прописал `ErrorHandler::register()` в `public/index.php`, он вешает `set_error_handler`, `set_exception_handler`, `register_shutdown_function`. Благодаря этому пользователи видят нормальное сообщение, а не «Undefined index» на пол-экрана.
3. **Статичная «убежище» страница** — `public/errors/safe.html`. Если серверу плохо (фатал), юзер летит туда, там короткий текст и ссылка назад на главную. Статика нужна, чтобы не зависеть от PHP, вдруг он вообще лег.
4. **Админка для ошибок** — добавил маршрут `/admin/error-log` и в `LogController` вывел новые карточки. Теперь админ может листать последние записи из `error.log`, смотреть сообщение, место и стектрейс (укороченный).
5. **Человеческие 404/500** — вместо `echo "404"` мы кидаем `HttpException`, который ловит обработчик. Пользователь получает подсказку «страница не найдена» и кнопку «вернуться домой».

## Ответы по требованиям

1. **«Обработайте ошибки и правильно информируйте пользователя»** — все непойманные баги теперь логируются и показывают юзеру дружелюбную фразу плюс ссылку на главную. 404, 500 и т.д. больше не раскрывают кода.
2. **«Протоколируйте ошибки»** — файл `storage/logs/error.log` создаётся автоматически, туда пишем JSON с типом, сообщением, файлом, линией и id пользователя, если он залогинен.
3. **Почему нельзя показывать сырые ошибки пользователю** — там часто видно имена таблиц, пути на сервере, версии PHP, что сильно помогает злоумышленнику. Поэтому мы показываем только безопасный текст, а детали оставляем в логах.
4. **Страница-убежище** — нужна, чтобы в момент фатала всё равно было куда посадить юзера и сказать «не паникуй». Она статическая, чтобы работала даже если PHP умер, и содержит ссылку назад в приложение.
5. **Опция для админа** — в меню теперь есть «Error Log», доступна только админам. Оттуда можно читать последние исключения и быстро понять, что ломается прямо сейчас.

## Как проверить

1. `docker compose up --build -d` в каталоге `php-app-secure`.
2. Зайти на сайт, залогиниться `admin/admin`.
3. Попробовать открыть несуществующую страницу, например `/ticket?id=9999` — увидите дружелюбный текст, в `error.log` появится запись.
4. Перейти в **Error Log** из верхнего меню — там появится новая карточка с вашим 404.

Вот и всё. Теперь приложение не орёт на пользователей, а админ знает, что происходит за кулисами. Если поймаете ещё какие-то ошибки — они тоже вывалятся в этот лог, так что не потеряем. 
