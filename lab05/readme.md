# Лабораторная 05 — отчёт

## 1. Общая информация
Работа выполнена на базе мини-приложения из ЛР №1 (`php-app-secure`). Среда развёрнута через Docker, БД — MySQL. В ходе задач выполнили модернизацию системы аутентификации, разграничения доступа по ролям и добавили демонстрацию уязвимого варианта панели.

## 2. Реализация требований

### 2.1 Демонстрация уязвимого доступа (п.1)
- Создан отдельный контроллер `AdminUnsafeController` и вью `create_user_insecure`.
- Роут `/admin/unsafe/create` не проверяет сессии: любой, кто знает URL, может открыть страницу и создать администратора.
- В отчёте преподавателю показываем, что в незалогиненом состоянии форма доступна сразу, что подтверждает наличие уязвимости.

### 2.2 Защищённая панель через сессии (п.2)
- Основная админка (`/admin/users/create`) по-прежнему требует сессию с ролью `admin`.
- Вход осуществляется через `AuthController::login`, где в `$_SESSION` записываются ID, email и роль пользователя.
- Без успешного логина попытки перейти на защищённые маршруты приводят к редиректу на `/login`.

### 2.3 Добавление роли «менеджер» (п.3)
- В таблицу `users` добавлено поле `role`, миграция `007_add_role_to_users.sql`.
- Миграция `008_insert_manager.sql` создает аккаунт `manager/manager`.
- Менеджер и админ попадают в общее «служебное» пространство: получают доступ к расширенному управлению тикетами и новому разделу пользователей.
- В меню появляется ссылка `User Directory`, доступная обоим ролям.

### 2.4 Авторизация и перенаправления (п.4)
- После логина роль выбирается из колонки `role`; в сессии выставляются флаги `is_admin`, `is_manager`.
- В зависимости от роли меняются доступные пункты меню и возможные действия.
- Пользователь (role = NULL) видит только пользовательские разделы, менеджер и админ — ещё и `/users`.

### 2.5 Функции для менеджера и контроль доступа (п.5)
- Создан контроллер `UserManagementController`.
- Раздел `/users` добавляет две ключевые функции для менеджера: просмотр списка учетных записей и изменение email.
- Дополнительно доступна операция удаления аккаунта; менеджер не может удалять себя и не имеет прав на аккаунты администраторов.
- Админ обладает полными правами в этом разделе, включая удаление любых пользователей (кроме самостоятельного self-delete — тоже запрещено).
- Это демонстрирует работающий механизм контроля доступа: обычный пользователь не авторизуется в разделе вовсе.

### 2.6 Выход с обоих «кабинетов» (п.6)
- В навигации для сотрудников присутствует пункт `Log Out`, который вызывает `AuthController::logout`.
- После вызова сессия очищается и пользователь попадает на главную/страницу входа, что фиксирует «сброс» для обеих ролей.

### 2.7 Демонстрация сценариев (п.7)
Для отчёта подготовлены последовательности действий:
1. **Менеджер**  
   - Логин `manager/manager`.  
   - Переход на `/users`, редактирование почты обычного пользователя.  
   - Проверка удаления одной тестовой записи.  
   - Работа с тикетами: просмотр `/tickets`, изменение статуса, удаление тикета.  
   - Логаут.
2. **Администратор**  
   - Логин `admin/admin`.  
   - Доступ к `/users` (включая админские учётки).  
   - Создание нового администратора через `/admin/users/create`.  
   - Проверка, что обычный пользователь не видит этих страниц.  
   - Логаут.

Эти действия показывают полный цикл для обеих ролей, что можно повторить на защите.

## 3. Миграции БД
1. `007_add_role_to_users.sql` — добавляет столбец `role` и заполняет его значениями `admin` для существующих администраторов.
2. `008_insert_manager.sql` — создаёт демонстрационный аккаунт менеджера.

После наката миграций необходимо перезапустить контейнеры или выполнить `docker-compose exec db mysql ...` согласно инструкциям в `README`.

## 4. Порядок запуска и проверки
1. `cp .env_example .env`, указать креды для БД.  
2. `docker-compose up --build -d`.  
3. Применить миграции (см. скрипт `script.sh` или выполнить вручную).  
4. Открыть `http://localhost:8080/`.  
5. Для демонстрации уязвимой панели перейти сразу на `/admin/unsafe/create`.  
6. Для основной функциональности: логиниться `admin/admin` или `manager/manager` и пройти все сценарии выше.

## 5. Замечания
- Раздел `/admin/unsafe/create` предназначен чисто для демонстрации. После сдачи лабораторной реккомендуется его отключить, чтобы не оставлять реальную дыру.
- При тестировании может потребоваться очистка таблиц или пересоздание контейнера БД, если уже были старые данные из предыдущих ЛР.
- В README проекта описаны все роли, сценарии и снапшоты экранов; настоятельно советуем их просмотреть перед защитой, чтобы не забыть о каких-то мелких шагах.

## 6. Вывод
Все пункты задания выполнены: уязвимость доказана, затем устранена через сессии; добавлен менеджер с отдельными полномочиями; реализованы роли и контроль доступа, а также механизм демонстрации для преподователя. Осытавшиеся действия — показать работеющий функционал и ответить на вопросы по коду и безопасности.
